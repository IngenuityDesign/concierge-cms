<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="cms-api">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <iron-ajax id="auth" url="{{url}}" method="GET" handle-as="json" content-type="application/json"
               last-response="{{data}}" on-response="storeResponse"></iron-ajax>
    <iron-ajax id="add_user" url="{{url}}" method="POST" handle-as="json"
               content-type="application/json" last-response="{{data}}"
               on-response="{{handleAdd}}"></iron-ajax>
    <iron-ajax id="get_users" url="{{url}}" method="GET" handle-as="json"
              content-type="application/json" last-response="{{data}}"
              on-response="{{handleGet}}"></iron-ajax>
    <iron-ajax id="add_note" url="{{url}}" method="POST" handle-as="json"
              content-type="application/json" last-response="{{data}}"
              on-response="{{handleAddNote}}"></iron-ajax>

    <iron-localstorage id="tokenStore" on-iron-localstorage-load-empty="authenticate"></iron-localstorage>
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'cms-api',
        properties: {
          items: {
            type: Array,
            notify: true,
          },
          token: {type:String},
          data: {type:Object}
        },
        apiBase: {type:String,value:'http://api.thinkforus.com/'},
        baseUrl: {type:String,value:'http://api.thinkforus.com/auth/linkedin'},
        url:{type:String},
        observers: [
          'storeResponse(data)',
          'authenticate()'
        ],
        ready: function() {
          var url = this.baseUrl.value;
          this.set('token','atoken');
          if(!this.token){
            var params = this.checkGetIsLinkedInResponse();
            if(params){
              this.url = url+'/callback' + params;
            }else{
              this.url = url;
            }
            this.authenticate();
          }
        },
        storeResponse: function(){
          if(this.token){return this.token;}
          if(!this.exists(this.data)) {return false;}
          if(this.exists(this.data.url)){
             this.pingLinkedIn();
             this.retrieveUserKey();
          }else if(this.exists(this.data.user)){
            var keys = ['email','firstName','lastName','fullname'];
            this.storeMultipleByResponseKey(this.data.user,keys,'user');
            this.checkStoreResponseKey(this.data,'jwt');
          }
        },
        pingLinkedIn:function(){
          window.location = this.data.url;
        },
        retrieveUserKey:function(){
          this.url = this.data.url+'/callback' + params;
          this.authenticate();
        },
        storeMultipleByResponseKey:function(data,keys){
          keys.map(function(key){
            this.checkSetStoreResponseKey(data,key);
          },this);
        },
        checkStoreResponseKey:function(data,key){
          if(this.exists(data[key])){
            this.set(key,data[key]);
          }
        },
        authenticate:function(){
          var auth =  this.$.auth;
          auth.generateRequest();
        },
        getToken:function(){
          //var store = this.$tokenStore;
          return this.token;
        },
        setRequestAuthHeader: function(headers) {
          headers.Authorization = 'Bearer ' + this.getToken()
          return headers;
        },
        checkGetIsLinkedInResponse:function(){
          var state = this.getQueryVar('state');
          var code  = this.getQueryVar('code');
          if(state && code){
            return '?code=code'+'&state='+state;
          }
          return false;
        },
        exists:function(item){
          return (typeof item !== 'undefined' && item !== null) ? true : false;
        },
        addUser:function(params){
          var adduser = this.$.add_user;
          adduser.url = this.apiBase+'users';
          adduser.params = params;
          this.setRequestAuthHeader(adduser.requestHeaders);
          adduser.generateRequest();
        },
        handleAdd:function(){

        },
        getUsers:function(){
          var getusers = this.$.get_users;
          getusers.url = this.apiBase+'users';
          getusers.params = params;
          this.setRequestAuthHeader(getusers.requestHeaders);
          getusers.generateRequest();
          return this.data;
        },
        handleGet:function(){

        },
        addNote:function(note){
          var addnote = this.$.add_note.url;
          addnote.url = this.apiBase+'notes';
          this.setRequestAuthHeader(addnote.requestHeaders);
          addnote.bodu = {"content":note};
          addnote.generateRequest();
        },
        handleAddNote:function(){
          if(this.data){

          }
        },
        getQueryVar:function(variable)
        {
               var query = window.location.search.substring(1);
               var vars = query.split("&");
               for (var i=0;i<vars.length;i++) {
                       var pair = vars[i].split("=");
                       if(pair[0] === variable){return pair[1];}
               }
               return(false);
        }
      });
    })();
  </script>
</dom-module>
